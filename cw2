#!/usr/bin/python3
import getopt
import sys
from data_loader import DataLoader
from gui_controller import Controller
from gui_controller import sort_by_readtime, sort_by_views


def start_gui(file_name, task=None, doc_id=None, reads_only=False):
    app = Controller(file_name, task=task, doc_id=doc_id, only_reads=reads_only)
    app.mainloop()
    return app


def main():
    argv = (sys.argv[1:])
    doc_id, task_id, user_id, file_name = get_args(argv)
    requires_error(file_name is None, "No file given (-f)")
    run_task(doc_id, task_id, user_id, file_name)


def get_args(argv):
    try:
        opts, args = getopt.getopt(argv, "u:d:t:f:")
    except getopt.GetoptError:
        print('Incorrect parameters specified')
        sys.exit(2)
    user_id, doc_id, file_name, task_id = None, None, None, None
    for opt, arg in opts:
        if opt == '-u':
            user_id = arg
        elif opt == '-d':
            doc_id = arg
        elif opt == '-t':
            task_id = arg
        elif opt == '-f':
            file_name = arg
    return doc_id, task_id, user_id, file_name


def run_task(doc_id, task_id, user_id, file_name):
    if task_id == '2a' or task_id == '2b' or task_id == '2':
        requires_error(doc_id is None, "No document id given")
        start_gui(file_name, task='2', doc_id=doc_id)
    elif task_id == '3a':
        start_gui(file_name, task=task_id, reads_only=False)
    elif task_id == '3b':
        start_gui(file_name, task=task_id, reads_only=False)
    elif task_id == '4':
        task_4(file_name)
    elif task_id == '5d':
        task_5(file_name, sort_by_readtime, doc_id, user_id)
    elif task_id == '5e':
        task_5(file_name, sort_by_views, doc_id, user_id)
    else:
        start_gui(file_name)


def task_4(file_name):
    data = DataLoader(file_name, only_reads=False)
    readers = sorted(data.visitors.values(), key=lambda r: r.total_view_time, reverse=True)
    for i, reader in enumerate(readers[:10], 1):
        print(str(i) + ": (" + reader.uuid + ", " + str(reader.total_view_time) + ")")


def task_5(file_name, sort, doc_id, user_id):
    requires_error(doc_id is None, "No document id given")
    data_loader = DataLoader(file_name)
    try:
        doc = data_loader.documents[doc_id]
    except KeyError:
        print("Document does not exist in data set")
        sys.exit(2)
    user = data_loader.visitors[user_id] or None
    also_likes = doc.also_likes(sort, user=user)
    if len(also_likes) == 0:
        print("No other likes found")
    else:
        print("Other liked documents:")
        for liked_doc in also_likes:
            print(liked_doc[0].doc_id + ": " + str(liked_doc[1][0]) + " view(s), "+str(liked_doc[1][1])+" read-time")


def requires_error(condition, msg):
    if condition:
        print(msg)
        sys.exit(2)

if __name__ == '__main__':
    main()
